
До этого момента мы работали с приложениями с одним контейнером. Но теперь мы хотим добавить MySQL в
стек приложений. Часто возникает следующий вопрос - "Где будет запускаться MySQL? Установите его в ту же
контейнер или запускать его отдельно?" В общем, **каждый контейнер должен делать что-то одно, и делать это хорошо.** Несколько
причины:

- Вполне вероятно, что вам придется масштабировать API и интерфейсы иначе, чем базы данных.
- Отдельные контейнеры позволяют создавать и обновлять версии изолированно.
- Хотя вы можете использовать контейнер для базы данных локально, вы можете захотеть использовать управляемую службу.
   для базы данных в производстве. Тогда вы не захотите поставлять ядро базы данных вместе со своим приложением.
- Для запуска нескольких процессов потребуется менеджер процессов (контейнер запускает только один процесс),
   что усложняет запуск/завершение работы контейнера.

И есть еще причины. Итак, мы обновим наше приложение, чтобы оно работало следующим образом:

![Todo App connected to MySQL container](multi-app-architecture.png)
{: .text-center }

## Контейнерная сеть

Помните, что контейнеры по умолчанию работают изолированно и ничего не знают о других процессах.
или контейнеры на одной машине. Итак, как нам позволить одному контейнеру взаимодействовать с другим? Ответ
**сетевое взаимодействие**. Теперь вам не обязательно быть сетевым инженером (ура!). Просто запомните это правило...

> Если два контейнера находятся в одной сети, они могут общаться друг с другом. Если нет, то они не могут.

## Запуск MySQL

Есть два способа разместить контейнер в сети: 1) назначить его при запуске или 2) подключить существующий контейнер.
На данный момент мы сначала создадим сеть и подключим контейнер MySQL при запуске.

1. Создайте сеть.

    ```bash
    docker network create todo-app
    ```

1. Запустите контейнер MySQL и подключите его к сети. Мы также собираемся определить несколько переменных среды, которые база 
   данных будет использовать для инициализации базы данных (см. раздел "Переменные среды" в [MySQL Docker Hub listing](https://hub.docker.com/_/mysql/)). 

    ```bash
    docker run -d \
        --network todo-app --network-alias mysql \
        -v todo-mysql-data:/var/lib/mysql \
        -e MYSQL_ROOT_PASSWORD=secret \
        -e MYSQL_DATABASE=todos \
        mysql:8.0
    ```

    Если вы используете PowerShell, используйте эту команду.

    ```powershell
    docker run -d `
        --network todo-app --network-alias mysql `
        -v todo-mysql-data:/var/lib/mysql `
        -e MYSQL_ROOT_PASSWORD=secret `
        -e MYSQL_DATABASE=todos `
        mysql:8.0
    ```

    Вы также увидите, что мы указали флаг `--network-alias`. Мы вернемся к этому через мгновение.

!!! info "Совет профессионала"
        Вы заметите, что здесь мы используем том с именем `todo-mysql-data` и монтируем его в `/var/lib/mysql`,
        где MySQL хранит свои данные. Однако мы никогда не запускали команду `docker volume create`. Docker понимает, что мы хотим
        использовать именованный том и автоматически создает его для нас.

1. Чтобы убедиться, что база данных запущена и работает, подключитесь к базе данных и убедитесь, что она подключается.

    ```bash
    docker exec -it <mysql-container-id> mysql -p
    ```

    Когда появится запрос пароля, введите **secret**. В оболочке MySQL перечислите базы данных и проверьте вы видите базу данных `todos`.

    ```cli
    mysql> SHOW DATABASES;
    ```

    Вы должны увидеть вывод, который выглядит так:

    ```plaintext
    +--------------------+
    | Database           |
    +--------------------+
    | information_schema |
    | mysql              |
    | performance_schema |
    | sys                |
    | todos              |
    +--------------------+
    5 rows in set (0.00 sec)
    ```

    Ура! У нас есть база данных `todos`, и она готова к использованию!

    Чтобы выйти из терминала sql, введите в терминале `exit`.

## Подключение к MySQL

Теперь, когда мы знаем, что MySQL запущен и работает, давайте воспользуемся им! Но вопрос... как?
Если мы запустим другой контейнер в той же сети, как нам его найти (помните, что у каждого контейнера есть свой IP-адрес)?

Чтобы разобраться в этом, мы воспользуемся контейнером [nicolaka/netshoot](https://github.com/nicolaka/netshoot),
который поставляется с множеством инструментов, полезных для устранения неполадок или отладки сетевых проблем.

1. Запустите новый контейнер, используя образ `nicolaka/netshoot`. Обязательно подключите его к той же сети.

    ```bash
    docker run -it --network todo-app nicolaka/netshoot
    ```

1. Внутри контейнера мы собираемся использовать команду `dig`, которая является полезным инструментом DNS. 
   Мы собираемся посмотреть IP-адрес для имени хоста `mysql`.

    ```bash
    dig mysql
    ```

    И вы получите такой результат...

    ```text
    ; <<>> DiG 9.18.8 <<>> mysql
    ;; global options: +cmd
    ;; Got answer:
    ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 32162
    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

    ;; QUESTION SECTION:
    ;mysql.				IN	A

    ;; ANSWER SECTION:
    mysql.			600	IN	A	172.23.0.2

    ;; Query time: 0 msec
    ;; SERVER: 127.0.0.11#53(127.0.0.11)
    ;; WHEN: Tue Oct 01 23:47:24 UTC 2019
    ;; MSG SIZE  rcvd: 44
    ```

    В "ANSWER SECTION" вы увидите запись `A` для `mysql`, которая разрешается как `172.23.0.2`.
    (ваш IP-адрес, скорее всего, будет иметь другое значение). Хотя `mysql` обычно не является допустимым именем хоста,
    Docker смог преобразовать его в IP-адрес контейнера, который имел этот сетевой псевдоним (помните флаг `--network-alias`, который мы использовали ранее?).

    Это означает, что... нашему приложению достаточно просто подключиться к хосту с именем `mysql`, и оно будет общаться с базой данных! Нет ничего проще!

    Когда вы закончите, запустите `exit`, чтобы выйти из контейнера.

## Запуск нашего приложения с MySQL

Приложение todo поддерживает настройку нескольких переменных среды для указания параметров подключения MySQL. Они есть:

- `MYSQL_HOST` - имя хоста работающего сервера MySQL;
- `MYSQL_USER` - имя пользователя, которое будет использоваться для подключения;
- `MYSQL_PASSWORD` - пароль, используемый для подключения;
- `MYSQL_DB` - база данных, которая будет использоваться после подключения.

!!! warning Setting Connection Settings via Env Vars

    Хотя использование переменных окружения для установки параметров соединения в целом подходит для разработки, это **КРАЙНЕ РАЗОЧАРОВАН** при запуске приложений в производстве.
    Диого Моника, бывший руководитель отдела безопасности в Docker, [написала потрясающий пост в блоге](https://diogomonica.com/2017/03/27/why-you-shouldnt-use-env-variables-for-secret-data/) объясняя почему.

    Более безопасный механизм использовать секретную поддержку (the secret support provided), предоставляемую вашей платформой оркестрации контейнеров.
    В большинстве случаев эти секреты монтируются в виде файлов в работающем контейнере. Вы увидите, что многие приложения (включая образ MySQL и приложение todo) 
    также поддерживают переменные окружения с суффиксом `_FILE`, указывающим на файл, содержащий переменную.

    Например, установка переменной `MYSQL_PASSWORD_FILE` приведет к тому, что приложение будет использовать содержимое указанного файла в качестве 
    пароля подключения. Docker ничего не делает для поддержки этих переменных окружения. Ваше приложение должно будет знать, как искать переменную и получать содержимое файла.

Объяснив все это,давайте запустим наш готовый к разработке контейнер!

1. Мы укажем каждую из указанных выше переменных среды, а также подключим контейнер к сети нашего приложения.

    ```bash hl_lines="3 4 5 6 7"
    docker run -dp 3000:3000 \
      -w /app -v "$(pwd):/app" \
      --network todo-app \
      -e MYSQL_HOST=mysql \
      -e MYSQL_USER=root \
      -e MYSQL_PASSWORD=secret \
      -e MYSQL_DB=todos \
      node:18-alpine \
      sh -c "yarn install && yarn run dev"
    ```

    Если вы используете PowerShell, используйте эту команду.

    ```powershell hl_lines="3 4 5 6 7"
    docker run -dp 3000:3000 `
      -w /app -v "$(pwd):/app" `
      --network todo-app `
      -e MYSQL_HOST=mysql `
      -e MYSQL_USER=root `
      -e MYSQL_PASSWORD=secret `
      -e MYSQL_DB=todos `
      node:18-alpine `
      sh -c "yarn install && yarn run dev"
    ```

1. Если мы посмотрим журналы контейнера (`docker logs <container-id>`), мы должны увидеть сообщение о том, что он использует базу данных mysql.

    ```plaintext hl_lines="7"
    # Previous log messages omitted
    $ nodemon src/index.js
    [nodemon] 2.0.20
    [nodemon] to restart at any time, enter `rs`
    [nodemon] watching path(s): *.*
    [nodemon] watching extensions: js,mjs,json
    [nodemon] starting `node src/index.js`
    Connected to mysql db at host mysql
    Listening on port 3000
    ```

1. Откройте приложение в браузере и добавьте несколько пунктов в свой список дел.

1. Подключитесь к базе данных mysql и убедитесь, что элементы записываются в базу данных. Помните, пароль
    является **secret**.

    ```bash
    docker exec -it <mysql-container-id> mysql -p todos
    ```

    И в оболочке MySQL выполните следующее:

    ```plaintext
    mysql> select * from todo_items;
    +--------------------------------------+--------------------+-----------+
    | id                                   | name               | completed |
    +--------------------------------------+--------------------+-----------+
    | c906ff08-60e6-44e6-8f49-ed56a0853e85 | Do amazing things! |         0 |
    | 2912a79e-8486-4bc3-a4c5-460793a575ab | Be awesome!        |         0 |
    +--------------------------------------+--------------------+-----------+
    ```

    Очевидно, что ваша таблица будет выглядеть иначе, потому что в ней есть ваши предметы. Но вы бы видели, как они там хранятся!

Если вы быстро посмотрите на панель управления Docker, вы увидите, что у нас работают два контейнера приложений. 
Но нет никаких реальных указаний на то, что они сгруппированы в одном приложении. Вскоре мы увидим, как это сделать лучше!

![Docker Dashboard showing two ungrouped app containers](dashboard-multi-container-app.png)

## Резюме

На данный момент у нас есть приложение, которое теперь хранит свои данные во внешней базе данных, работающей в отдельном контейнере. 
Мы немного узнали о контейнерных сетях и увидели, как можно выполнить обнаружение сервисов с помощью DNS.

Но есть большая вероятность, что вы начинаете чувствовать себя немного перегруженным всем, что вам нужно сделать, чтобы запустить это приложение. 
Нам нужно создать сеть, запустить контейнеры, указать все переменные среды, открыть порты и многое другое! Это нужно помнить, 
и это, безусловно, затрудняет передачу информации кому-то другому.

В следующем разделе мы поговорим о Docker Compose. С помощью Docker Compose мы можем гораздо проще делиться стеками наших приложений и 
позволять другим запускать их с помощью одной (и простой) команды!